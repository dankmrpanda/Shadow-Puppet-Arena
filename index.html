<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no">
    <title>Shadow Puppet Arena</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: radial-gradient(ellipse at 50% 40%, #1a1028 0%, #0d0d12 60%, #080810 100%);
            color: #e0e0e0;
            font: 14px sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center
        }

        #lobby {
            text-align: center;
            padding: 15px
        }

        #lobby input,
        #lobby button {
            font-size: 16px;
            padding: 10px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid #444
        }

        #lobby button {
            background: #4a2d8e;
            color: #fff;
            cursor: pointer
        }

        #qr {
            display: none;
            margin: 10px;
            background: #fff;
            padding: 8px;
            border-radius: 8px
        }

        #c {
            background: #1a1a24;
            border-radius: 8px;
            display: none;
            cursor: crosshair;
            max-width: 95vw;
            max-height: 50vh;
            border: 2px solid #333
        }

        #ui {
            display: none;
            padding: 10px;
            text-align: center
        }

        #ui input,
        #ui button {
            font-size: 14px;
            padding: 8px;
            margin: 4px;
            border-radius: 6px;
            border: 1px solid #444
        }

        #ui button {
            background: #4a2d8e;
            color: #fff
        }

        #arena {
            display: none;
            width: 100%;
            flex: 1;
            flex-direction: column;
            align-items: center;
            padding-top: 10px
        }

        #ac {
            background: #1a1a24;
            border-radius: 8px;
            max-width: 100%;
            max-height: 55vh
        }

        #qrDraw {
            display: none;
            margin: 5px
        }

        #controls {
            display: flex;
            gap: 8px;
            align-items: stretch;
            margin: 8px 0;
            width: 90%;
            max-width: 500px;
            justify-content: center
        }

        #controls button {
            flex: 1;
            max-width: 200px;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            padding: 8px 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: opacity 0.2s
        }

        #controls button:disabled {
            opacity: 0.4;
            cursor: default
        }

        #controls button .btn-label {
            font-size: 14px
        }

        #controls button .btn-desc {
            font-size: 9px;
            opacity: 0.7;
            font-weight: normal
        }

        #controls button .btn-cd {
            font-size: 11px;
            opacity: 0.8
        }

        #blastBtn {
            background: linear-gradient(135deg, #e74c3c, #c0392b)
        }

        #abilityBtn {
            background: linear-gradient(135deg, #8e44ad, #6c3483)
        }

        #log {
            font-size: 11px;
            color: #aaa;
            max-height: 60px;
            overflow-y: auto;
            width: 90%;
            text-align: left;
            padding: 6px;
            background: rgba(15, 15, 25, 0.8);
            border-radius: 6px;
            margin-top: 4px
        }

        .hint {
            font-size: 11px;
            color: #888;
            margin: 4px
        }

        #clear {
            background: #555
        }
    </style>
</head>

<body>
    <div id=lobby>
        <h1>Shadow Puppet Arena</h1>
        <p style=margin:8px>Draw a shape. Up to 6 players!</p><button id=create>Create Game</button><br><input id=code
            placeholder="Room code" maxlength=4 style=text-transform:uppercase><button id=join>Join</button>
        <div id=qr></div>
        <p id=msg style=margin-top:15px;color:#888>Connecting...</p>
    </div>
    <div id=ui style=display:none>
        <p id=room>Room: ---</p>
        <div id=qrDraw></div>
        <p id=count></p><input id=mname placeholder="Name your shape" maxlength=12><br><canvas id=c width=300
            height=300></canvas>
        <p class=hint>Draw in ONE stroke. Shape will auto-close.</p>
        <p id=drawStatus style=margin:4px>Draw your monster</p><button id=loadPrev
            style=display:none;background:#2980b9>Load Previous</button><button id=loadScotty
            style=background:#c0392b;margin-left:4px>Load Scotty üêï</button><button id=clear>Clear</button><button
            id=done>Ready!</button><button id=unready style=display:none;background:#666>Unready</button>
    </div>
    <div id=arena><canvas id=ac width=900 height=640></canvas>
        <div id=controls>
            <button id=blastBtn><span class=btn-label>üí® Blast</span><span class=btn-desc>Push all nearby</span><span class=btn-cd>Ready</span></button>
            <button id=abilityBtn><span class=btn-label>Ability</span><span class=btn-desc></span><span class=btn-cd></span></button>
        </div>
        <div id=log></div>
    </div>
    <script>
        (function () {
            var lobby = document.getElementById('lobby'), ui = document.getElementById('ui'), arena = document.getElementById('arena'), c = document.getElementById('c'), ac = document.getElementById('ac'), msg = document.getElementById('msg'), room = document.getElementById('room'), count = document.getElementById('count'), qr = document.getElementById('qr'), done = document.getElementById('done'), unready = document.getElementById('unready'), log = document.getElementById('log'), blastBtn = document.getElementById('blastBtn'), clearBtn = document.getElementById('clear'), loadPrevBtn = document.getElementById('loadPrev'), loadScottyBtn = document.getElementById('loadScotty'), abilityBtn = document.getElementById('abilityBtn');
            var W = 300, H = 300, path = [], playerId = 0, myColor = '#6a4c93', monsters = {}, packs = [], powerups = [], hazards = [], particles = [], ws, isReady = false, bounds = [0, 0, 900, 640];
            var blastCooldown = 0, abilityCooldown = 0, blastFx = [], floatTexts = [], isDead = false, hasSavedShape = false, savedPath = [];
            var lightningWarning = null, lightningStrike = null, suddenDeath = false, myAbility = 'none', isScotty = false;
            var WS_URL = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + (location.host || 'localhost:3000');
            var retries = 0;
            function post(m) { msg.textContent = m; msg.style.color = '#888' }
            function postErr(m) { msg.textContent = m; msg.style.color = '#e66' }
            function addLog(t) { log.innerHTML += '<div>' + t + '</div>'; log.scrollTop = log.scrollHeight }
            function connect() {
                post(retries ? 'Retrying...' : 'Connecting...'); ws = new WebSocket(WS_URL);
                ws.onopen = function () { retries = 0; post('Connected!'); var r = null, u = new URL(location.href); if (u.searchParams.get('room')) r = u.searchParams.get('room'); var m = location.pathname.match(/\/join\/([A-Za-z]{4})/i); if (m) r = m[1]; if (r) { var code = r.toUpperCase().slice(0, 4); document.getElementById('code').value = code; ws.send(JSON.stringify({ t: 'join', code: code })) } };
                ws.onclose = function () { postErr('Disconnected.' + (retries < 5 ? ' Retrying...' : ' Refresh.')); if (retries < 5) { retries++; setTimeout(connect, 3000) } };
                ws.onmessage = function (e) {
                    var d = JSON.parse(e.data);
                    if (d.t === 'code') { room.textContent = 'Room: ' + d.code; var joinUrl = location.origin + '/join/' + d.code; var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + encodeURIComponent(joinUrl); qr.innerHTML = '<img src="' + qrUrl + '" alt=QR>'; qr.style.display = 'block'; document.getElementById('qrDraw').innerHTML = '<img src="' + qrUrl + '" alt=QR style=background:#fff;padding:4px;border-radius:6px>'; document.getElementById('qrDraw').style.display = 'block'; post('Share QR or code: ' + d.code) }
                    else if (d.t === 'joined') { count.textContent = (d.count || 0) + ' players'; post('Player joined!') }
                    else if (d.t === 'status') { count.textContent = d.ready + '/' + d.total + ' ready' }
                    else if (d.t === 'start') { lobby.style.display = 'none'; ui.style.display = 'block'; c.style.display = 'block'; playerId = d.id; if (d.color) myColor = d.color }
                    else if (d.t === 'arena') {
                        monsters = d.m; packs = d.pk || []; powerups = d.pu || []; hazards = d.hz || []; particles = d.pt || [];
                        if (d.b) bounds = d.b;
                        if (d.bl) for (var bi = 0; bi < d.bl.length; bi++) blastFx.push({ x: d.bl[bi].x, y: d.bl[bi].y, age: 0 });
                        if (d.ft) for (var fi = 0; fi < d.ft.length; fi++) floatTexts.push({ x: d.ft[fi].x, y: d.ft[fi].y, text: d.ft[fi].text, color: d.ft[fi].color, age: 0 });
                        lightningWarning = d.lw; lightningStrike = d.ls; suddenDeath = d.sd;
                        lobby.style.display = 'none'; ui.style.display = 'none'; arena.style.display = 'flex';
                        if (d.log) for (var i = 0; i < d.log.length; i++) addLog(d.log[i]);
                        if (!monsters[playerId] && !isDead) { isDead = true; blastBtn.disabled = true; blastBtn.style.background = '#333'; abilityBtn.disabled = true; abilityBtn.style.background = '#333'; }
                        else if (monsters[playerId]) { myAbility = monsters[playerId].ability || 'none'; }
                        renderArena()
                    }
                    else if (d.t === 'restart') { isDead = false; hasSavedShape = true; if (path.length > 3) savedPath = path.slice(); arena.style.display = 'none'; ui.style.display = 'block'; c.style.display = 'block'; isReady = false; done.style.display = 'inline-block'; unready.style.display = 'none'; blastBtn.disabled = false; blastBtn.style.background = ''; blastCooldown = 0; abilityCooldown = 0; abilityBtn.disabled = false; abilityBtn.style.background = ''; blastFx = []; if (savedPath.length > 3) { loadPrevBtn.style.display = 'inline-block'; document.getElementById('drawStatus').textContent = 'Load previous shape or draw new'; } else { document.getElementById('drawStatus').textContent = 'Draw your monster'; } document.getElementById('drawStatus').style.color = '#888'; if (path.length > 3) drawMonster() }
                    else if (d.t === 'full') { postErr('Room full') }
                    else if (d.t === 'invalid') { postErr('Invalid code') }
                }
            }
            function createGame() { if (ws && ws.readyState === 1) ws.send(JSON.stringify({ t: 'create' })); else postErr('Connecting...') }
            function joinGame() {
                var code = document.getElementById('code').value.toUpperCase().slice(0, 4); if (!code || code.length < 4) { postErr('Code is 4 letters'); return }
                ws.send(JSON.stringify({ t: 'join', code: code }))
            }
            document.getElementById('create').onclick = createGame;
            document.getElementById('join').onclick = joinGame;
            function analyze() {
                var p = path;
                var pts = []; for (var i = 0; i < p.length; i++) pts.push({ x: p[i].x, y: p[i].y });
                if (pts.length > 25) { var np = []; for (var i = 0; i < 20; i++)np.push(pts[Math.floor(i * (pts.length - 1) / 19)]); pts = np }
                var corners = 0; for (var i = 2; i < pts.length; i++) {
                    var a = Math.atan2(pts[i].y - pts[i - 1].y, pts[i].x - pts[i - 1].x), b = Math.atan2(pts[i - 1].y - pts[i - 2].y, pts[i - 1].x - pts[i - 2].x);
                    var diff = Math.abs(a - b); if (diff > Math.PI) diff = 2 * Math.PI - diff; if (diff > 1.0) corners++
                }
                var cx = 0, cy = 0; for (var i = 0; i < pts.length; i++) { cx += pts[i].x; cy += pts[i].y } cx /= pts.length; cy /= pts.length;
                var left = 0, right = 0; for (var i = 0; i < pts.length; i++) { var v = pts[i].y - cy; if (pts[i].x < cx) left += v * v; else right += v * v }
                var sym = Math.min(1, 1 - Math.abs(left - right) / (left + right + 1));
                var segs = []; for (var i = 1; i < pts.length; i++)segs.push(Math.hypot(pts[i].x - pts[i - 1].x, pts[i].y - pts[i - 1].y));
                var avg = segs.reduce(function (a, b) { return a + b }, 0) / segs.length; var legs = 0; for (var i = 0; i < segs.length; i++)if (segs[i] > avg * 1.8) legs++;

                var mx = 1e9, my = 1e9, Mx = 0, My = 0; for (var i = 0; i < pts.length; i++) { mx = Math.min(mx, pts[i].x); my = Math.min(my, pts[i].y); Mx = Math.max(Mx, pts[i].x); My = Math.max(My, pts[i].y) }
                var sw = Mx - mx || 1, sh = My - my || 1, sc = Math.min(220 / sw, 220 / sh), ox = 150 - (mx + Mx) / 2 * sc, oy = 150 - (my + My) / 2 * sc;
                var outP = []; var ns = Math.min(pts.length, 20); for (var i = 0; i < ns; i++) { var j = Math.floor(i * (pts.length - 1) / (ns - 1)); outP.push([Math.round((pts[j].x * sc + ox) / 12), Math.round((pts[j].y * sc + oy) / 12)]) }
                var area = 0; for (var i = 0; i < outP.length; i++) { var j2 = (i + 1) % outP.length; area += outP[i][0] * outP[j2][1] - outP[j2][0] * outP[i][1] } area = Math.abs(area) / 2;
                if (isScotty) return { a: area, c: 20, s: 1.0, l: 5, p: outP, n: 'Scotty' };
                return { a: area, c: corners, s: sym, l: legs, p: outP, n: (document.getElementById('mname').value || '???').slice(0, 12) }
            }
            function drawMonster() {
                var ctx = c.getContext('2d'), pts = path;
                if (pts.length < 3) return null;
                var stats = analyze();
                ctx.fillStyle = '#1a1a24'; ctx.fillRect(0, 0, W, H);
                ctx.fillStyle = myColor; ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); for (var i = 1; i < pts.length; i++)ctx.lineTo(pts[i].x, pts[i].y); ctx.closePath(); ctx.fill();
                var name = document.getElementById('mname').value || '';
                if (name) { ctx.fillStyle = '#fff'; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(name, W / 2, 20) }
                return stats
            }
            var abilityDescs = { dash: 'Speed burst forward', block: 'Invincible 4s', absorb: 'Heal 75% on hit', none: '' };
            var abilityIcons = { dash: '‚ö°', block: 'üõ°', absorb: 'üíö', none: '' };
            var puLabels = { speed: '2x SPEED', shield: 'SHIELD', damage: '2x DMG', ghost: 'PHASE' };
            function renderArena() {
                var ctx = ac.getContext('2d');
                // Arena background with subtle gradient
                var bgGrad = ctx.createRadialGradient(450, 320, 50, 450, 320, 500);
                bgGrad.addColorStop(0, '#1a1020'); bgGrad.addColorStop(1, '#080810');
                ctx.fillStyle = bgGrad; ctx.fillRect(0, 0, 900, 640);
                // Playable area
                var bw = bounds[2] - bounds[0], bh = bounds[3] - bounds[1];
                var aGrad = ctx.createRadialGradient(bounds[0] + bw / 2, bounds[1] + bh / 2, 30, bounds[0] + bw / 2, bounds[1] + bh / 2, Math.max(bw, bh) * 0.7);
                aGrad.addColorStop(0, '#12121e'); aGrad.addColorStop(1, '#0a0a14');
                ctx.fillStyle = aGrad; ctx.fillRect(bounds[0], bounds[1], bw, bh);
                var isShrunk = bounds[0] > 0 || bounds[1] > 0 || bounds[2] < 900 || bounds[3] < 640;
                ctx.strokeStyle = isShrunk ? '#ff0000' : 'rgba(100,80,140,0.4)'; ctx.lineWidth = isShrunk ? 3 : 1; ctx.strokeRect(bounds[0], bounds[1], bw, bh);

                // Draw hazards
                for (var hi = 0; hi < hazards.length; hi++) {
                    var hz = hazards[hi];
                    if (hz.type === 'fire') {
                        ctx.fillStyle = 'rgba(255,100,0,0.4)'; ctx.beginPath(); ctx.arc(hz.x, hz.y, 50, 0, Math.PI * 2); ctx.fill();
                        ctx.fillStyle = '#f80'; ctx.font = '16px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('üî•', hz.x, hz.y);
                        ctx.fillStyle = 'rgba(255,140,0,0.7)'; ctx.font = 'bold 8px sans-serif'; ctx.fillText('BURNS', hz.x, hz.y + 14);
                    } else if (hz.type === 'vortex') {
                        ctx.strokeStyle = 'rgba(128,0,255,0.6)'; ctx.lineWidth = 3;
                        for (var vi = 0; vi < 3; vi++) { ctx.beginPath(); ctx.arc(hz.x, hz.y, 30 + vi * 25, 0, Math.PI * 2); ctx.stroke(); }
                        ctx.fillStyle = '#808'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('üåÄ', hz.x, hz.y);
                        ctx.fillStyle = 'rgba(180,0,255,0.7)'; ctx.font = 'bold 8px sans-serif'; ctx.fillText('PULLS', hz.x, hz.y + 14);
                    }
                }
                // Lightning warning/strike
                if (lightningWarning) {
                    ctx.strokeStyle = 'rgba(255,255,0,0.7)'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                    ctx.beginPath(); ctx.arc(lightningWarning.x, lightningWarning.y, 60, 0, Math.PI * 2); ctx.stroke();
                    ctx.setLineDash([]); ctx.fillStyle = '#ff0'; ctx.font = '20px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('‚ö°', lightningWarning.x, lightningWarning.y);
                }
                if (lightningStrike) {
                    ctx.fillStyle = 'rgba(255,255,200,0.8)'; ctx.beginPath(); ctx.arc(lightningStrike.x, lightningStrike.y, 60, 0, Math.PI * 2); ctx.fill();
                }

                // Health packs
                for (var pi = 0; pi < packs.length; pi++) {
                    var pk = packs[pi];
                    ctx.fillStyle = '#2ecc71'; ctx.beginPath(); ctx.arc(pk.x, pk.y, 10, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillRect(pk.x - 6, pk.y - 2, 12, 4); ctx.fillRect(pk.x - 2, pk.y - 6, 4, 12);
                    ctx.fillStyle = '#155d32'; ctx.font = 'bold 9px sans-serif'; ctx.fillText(pk.hp, pk.x, pk.y + 16);
                }
                // Power-ups
                var puColors = { speed: '#ff0', shield: '#08f', damage: '#f00', ghost: '#aaa' };
                var puSymbols = { speed: '‚ö°', shield: 'üõ°', damage: 'üí•', ghost: 'üëª' };
                for (var pi = 0; pi < powerups.length; pi++) {
                    var pu = powerups[pi];
                    // Outer glow
                    ctx.save(); ctx.globalAlpha = 0.25;
                    ctx.fillStyle = puColors[pu.type] || '#fff'; ctx.beginPath(); ctx.arc(pu.x, pu.y, 20, 0, Math.PI * 2); ctx.fill();
                    ctx.restore();
                    // Circle
                    ctx.fillStyle = puColors[pu.type] || '#fff'; ctx.beginPath(); ctx.arc(pu.x, pu.y, 12, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#000'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(puSymbols[pu.type] || '?', pu.x, pu.y);
                    // Label underneath
                    ctx.fillStyle = puColors[pu.type] || '#fff'; ctx.font = 'bold 8px sans-serif';
                    ctx.fillText(puLabels[pu.type] || '', pu.x, pu.y + 20);
                }
                // Monsters
                for (var id in monsters) {
                    var m = monsters[id];
                    if (!m.path || !m.path.length) continue;
                    var sc = m.size / 40;
                    var pcx = 0, pcy = 0; for (var i = 0; i < m.path.length; i++) { pcx += m.path[i][0] * 12; pcy += m.path[i][1] * 12 } pcx /= m.path.length; pcy /= m.path.length;
                    // Trail effect
                    if (m.trail && m.trail.length > 1) {
                        for (var ti = 0; ti < m.trail.length - 1; ti++) {
                            var alpha = (ti / m.trail.length) * 0.4;
                            ctx.globalAlpha = alpha;
                            ctx.fillStyle = m.color;
                            ctx.beginPath(); ctx.arc(m.trail[ti].x, m.trail[ti].y, m.size * 0.3 * (ti / m.trail.length), 0, Math.PI * 2); ctx.fill();
                        }
                        ctx.globalAlpha = 1;
                    }
                    // Effect glow + label - compute bounding radius from actual shape vertices
                    if (m.effects && (m.effects.speed || m.effects.shield || m.effects.damage || m.effects.ghost)) {
                        var maxR = 0;
                        for (var ei = 0; ei < m.path.length; ei++) {
                            var edx = (m.path[ei][0] * 12 - pcx) * sc;
                            var edy = (m.path[ei][1] * 12 - pcy) * sc;
                            var er = Math.hypot(edx, edy);
                            if (er > maxR) maxR = er;
                        }
                        var glowR = maxR + 8;
                        ctx.save(); ctx.globalAlpha = 0.35;
                        ctx.fillStyle = m.effects.shield ? '#08f' : m.effects.speed ? '#ff0' : m.effects.damage ? '#f00' : '#aaa';
                        ctx.beginPath(); ctx.arc(m.x, m.y, glowR, 0, Math.PI * 2); ctx.fill();
                        ctx.restore();
                        // Small effect label below monster
                        var eLbl = m.effects.shield ? 'üõ° SHIELD' : m.effects.speed ? '‚ö° FAST' : m.effects.damage ? 'üí• 2xDMG' : 'üëª PHASE';
                        var eClr = m.effects.shield ? '#4af' : m.effects.speed ? '#ff0' : m.effects.damage ? '#f66' : '#ccc';
                        ctx.save(); ctx.globalAlpha = 0.9;
                        ctx.fillStyle = eClr; ctx.font = 'bold 8px sans-serif'; ctx.textAlign = 'center';
                        ctx.fillText(eLbl, m.x, m.y + maxR + 14);
                        ctx.restore();
                    }
                    ctx.save(); ctx.translate(m.x, m.y); ctx.scale(sc, sc);
                    ctx.fillStyle = m.effects && m.effects.ghost ? 'rgba(255,255,255,0.3)' : m.color; ctx.beginPath();
                    ctx.moveTo((m.path[0][0] * 12 - pcx), (m.path[0][1] * 12 - pcy));
                    for (var i = 1; i < m.path.length; i++) ctx.lineTo((m.path[i][0] * 12 - pcx), (m.path[i][1] * 12 - pcy));
                    ctx.closePath(); ctx.fill();
                    ctx.restore();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.max(10, Math.round(12 * sc)) + 'px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(Math.ceil(m.hp), m.x, m.y);
                    if (m.name) { ctx.font = Math.max(9, Math.round(10 * sc)) + 'px sans-serif'; ctx.fillText(m.name, m.x, m.y - m.size * 1.5 - 6) }
                }
                // Death explosion particles
                for (var pi = 0; pi < particles.length; pi++) {
                    var p = particles[pi];
                    var alpha = Math.max(0, 1 - p.age / 30);
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI * 2); ctx.fill();
                }
                ctx.globalAlpha = 1;
                // Blast effects
                for (var bi = blastFx.length - 1; bi >= 0; bi--) {
                    var bf = blastFx[bi]; bf.age++;
                    var r = bf.age * 4; var alpha = Math.max(0, 1 - bf.age / 20);
                    ctx.strokeStyle = 'rgba(255,255,255,' + alpha + ')'; ctx.lineWidth = Math.max(1, 4 - bf.age * 0.15);
                    ctx.beginPath(); ctx.arc(bf.x, bf.y, r, 0, Math.PI * 2); ctx.stroke();
                    ctx.strokeStyle = 'rgba(255,255,255,' + (alpha * 0.5) + ')'; ctx.beginPath(); ctx.arc(bf.x, bf.y, r * 0.6, 0, Math.PI * 2); ctx.stroke();
                    if (bf.age > 20) blastFx.splice(bi, 1);
                }
                // Float texts
                for (var fi = floatTexts.length - 1; fi >= 0; fi--) {
                    var ft = floatTexts[fi]; ft.age++;
                    ctx.globalAlpha = Math.max(0, 1 - ft.age / 40);
                    ctx.fillStyle = ft.color; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText(ft.text, ft.x, ft.y - ft.age * 0.8);
                    ctx.globalAlpha = 1;
                    if (ft.age > 40) floatTexts.splice(fi, 1);
                }
                updateButtons();
            }
            function updateButtons() {
                if (isDead) {
                    blastBtn.innerHTML = '<span class=btn-label>Dead</span>';
                    abilityBtn.innerHTML = '<span class=btn-label>Dead</span>';
                    return;
                }
                var bcdText = blastCooldown > 0 ? blastCooldown + 's' : 'Ready';
                blastBtn.innerHTML = '<span class=btn-label>üí® Blast</span><span class=btn-desc>Push all nearby</span><span class=btn-cd>' + bcdText + '</span>';
                var abName = myAbility === 'none' ? 'No Ability' : (abilityIcons[myAbility] || '') + ' ' + myAbility.charAt(0).toUpperCase() + myAbility.slice(1);
                var abDesc = abilityDescs[myAbility] || '';
                var acdText = myAbility === 'none' ? '' : (abilityCooldown > 0 ? abilityCooldown + 's' : 'Ready');
                abilityBtn.innerHTML = '<span class=btn-label>' + abName + '</span><span class=btn-desc>' + abDesc + '</span><span class=btn-cd>' + acdText + '</span>';
            }
            done.onclick = function () {
                if (hasSavedShape && path.length < 10) {
                    ws.send(JSON.stringify({ t: 'monster', reuse: true })); isReady = true; done.style.display = 'none'; unready.style.display = 'inline-block'; document.getElementById('drawStatus').textContent = 'Ready! Waiting for others...'; return
                }
                if (path.length < 10) { document.getElementById('drawStatus').textContent = 'Draw a shape first'; document.getElementById('drawStatus').style.color = '#e66'; return }
                var s = drawMonster(); if (!s) { document.getElementById('drawStatus').textContent = 'Draw a valid shape'; document.getElementById('drawStatus').style.color = '#e66'; return }
                hasSavedShape = false; savedPath = path.slice(); ws.send(JSON.stringify({ t: 'monster', m: s })); isReady = true; done.style.display = 'none'; unready.style.display = 'inline-block'; loadPrevBtn.style.display = 'none'; document.getElementById('drawStatus').textContent = 'Ready! Waiting for others...'
            };
            unready.onclick = function () {
                ws.send(JSON.stringify({ t: 'unready' })); isReady = false; unready.style.display = 'none'; done.style.display = 'inline-block'; document.getElementById('drawStatus').textContent = 'Draw your shape'
            };
            clearBtn.onclick = function () {
                if (isReady) return;
                path = [];
                var ctx = c.getContext('2d'); ctx.fillStyle = '#1a1a24'; ctx.fillRect(0, 0, W, H);
                document.getElementById('drawStatus').textContent = 'Draw your shape'; document.getElementById('drawStatus').style.color = '#888'
            };
            loadPrevBtn.onclick = function () {
                if (isReady || savedPath.length < 10) return;
                path = savedPath.slice();
                drawMonster();
                document.getElementById('drawStatus').textContent = 'Previous shape loaded!'; document.getElementById('drawStatus').style.color = '#2ecc71'
            };
            loadScottyBtn.onclick = function () {
                if (isReady) return;
                // Scotty dog path (approximate profile)
                path = [
                    { x: 280, y: 130 }, // Nose Tip
                    { x: 280, y: 160 }, { x: 260, y: 190 }, { x: 245, y: 170 }, // Beard
                    { x: 230, y: 200 }, // Chest
                    { x: 230, y: 260 }, { x: 210, y: 260 }, { x: 210, y: 220 }, // Front Leg
                    { x: 190, y: 220 }, { x: 130, y: 220 }, // Belly
                    { x: 120, y: 260 }, { x: 90, y: 260 }, { x: 90, y: 210 }, // Back Leg
                    { x: 60, y: 180 }, // Rump
                    { x: 50, y: 130 }, { x: 45, y: 80 }, { x: 65, y: 120 }, // Tail
                    { x: 90, y: 130 }, { x: 190, y: 130 }, // Back
                    { x: 195, y: 70 }, { x: 205, y: 40 }, { x: 215, y: 70 }, // Ear Back
                    { x: 220, y: 70 }, { x: 230, y: 40 }, { x: 240, y: 70 }, // Ear Front
                    { x: 250, y: 90 }, // Forehead
                    { x: 255, y: 110 }, // Stop
                    { x: 280, y: 110 }  // Snout Top
                ];
                // Skip smoothing for defined features
                path.push({ x: path[0].x, y: path[0].y }); // Close
                isScotty = true;
                document.getElementById('mname').value = 'Scotty';
                drawMonster();
                document.getElementById('drawStatus').textContent = 'Scotty Loaded!'; document.getElementById('drawStatus').style.color = '#c0392b';
            };
            function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)) }
            function getXY(e) { var r = c.getBoundingClientRect(), sx = W / r.width, sy = H / r.height; var px = (e.touches ? e.touches[0].clientX : e.clientX) - r.left, py = (e.touches ? e.touches[0].clientY : e.clientY) - r.top; return { x: clamp(px * sx, 5, W - 5), y: clamp(py * sy, 5, H - 5) } }
            function onDown(e) { if (isReady) return; isScotty = false; var p = getXY(e); path = [p] }
            function smooth(p) { for (var k = 0; k < 2; k++) { var n = []; for (var i = 0; i < p.length; i++) { var a = p[i - 1] || p[0], b = p[i], cc = p[i + 1] || p[p.length - 1]; n.push({ x: (a.x + b.x * 2 + cc.x) / 4, y: (a.y + b.y * 2 + cc.y) / 4 }) } p = n } return p }
            function onMove(e) {
                if (path.length === 0 || isReady) return; var p = getXY(e); path.push(p); var draw = smooth(path.slice()); var ctx = c.getContext('2d'); ctx.fillStyle = '#1a1a24'; ctx.fillRect(0, 0, W, H); ctx.strokeStyle = myColor; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(draw[0].x, draw[0].y); for (var i = 1; i < draw.length; i++)ctx.lineTo(draw[i].x, draw[i].y); ctx.stroke();
                if (draw.length > 5) { var d = Math.hypot(draw[0].x - draw[draw.length - 1].x, draw[0].y - draw[draw.length - 1].y); ctx.strokeStyle = d < 50 ? 'rgba(46,204,113,0.5)' : 'rgba(231,76,60,0.3)'; ctx.setLineDash([5, 5]); ctx.beginPath(); ctx.moveTo(draw[draw.length - 1].x, draw[draw.length - 1].y); ctx.lineTo(draw[0].x, draw[0].y); ctx.stroke(); ctx.setLineDash([]) }
            }
            function onUp() {
                if (path.length < 10 || isReady) return; path = smooth(path);
                var gap = Math.hypot(path[0].x - path[path.length - 1].x, path[0].y - path[path.length - 1].y);
                if (gap > 5) { var steps = Math.max(2, Math.ceil(gap / 10)); var ex = path[path.length - 1].x, ey = path[path.length - 1].y; for (var i = 1; i <= steps; i++) { var t = i / steps; path.push({ x: ex * (1 - t) + path[0].x * t, y: ey * (1 - t) + path[0].y * t }) } }
                path.push({ x: path[0].x, y: path[0].y });
                document.getElementById('drawStatus').textContent = 'Shape ready!'; document.getElementById('drawStatus').style.color = '#2ecc71'; drawMonster()
            }
            c.addEventListener('touchstart', function (e) { e.preventDefault(); onDown(e) });
            c.addEventListener('touchmove', function (e) { e.preventDefault(); onMove(e) });
            c.addEventListener('touchend', function (e) { e.preventDefault(); if (e.touches.length === 0) onUp() });
            c.addEventListener('mousedown', onDown);
            c.addEventListener('mousemove', function (e) { if (e.buttons) onMove(e) });
            c.addEventListener('mouseup', onUp);
            blastBtn.onclick = function () {
                if (blastCooldown > 0 || isDead) return;
                ws.send(JSON.stringify({ t: 'blast' }));
                blastCooldown = 5; blastBtn.disabled = true;
                var cd = setInterval(function () { blastCooldown--; updateButtons(); if (blastCooldown <= 0) { clearInterval(cd); if (!isDead) { blastBtn.disabled = false; blastBtn.style.background = '' } } }, 1000);
                updateButtons();
            };
            abilityBtn.onclick = function () {
                if (abilityCooldown > 0 || isDead || myAbility === 'none') return;
                ws.send(JSON.stringify({ t: 'ability' }));
                abilityCooldown = myAbility === 'dash' ? 8 : 10; abilityBtn.disabled = true;
                var cd = setInterval(function () { abilityCooldown--; updateButtons(); if (abilityCooldown <= 0) { clearInterval(cd); if (!isDead) { abilityBtn.disabled = false; abilityBtn.style.background = '' } } }, 1000);
                updateButtons();
            };
            setInterval(function () { if (arena.style.display === 'flex' && Object.keys(monsters).length) renderArena() }, 16);
            connect();
        })();
    </script>
</body>

</html>